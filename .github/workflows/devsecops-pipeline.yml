name: DevSecOps Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    # Security Scanning - Dependency Check
    dependency-check:
        name: Dependency Security Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install dependencies - User Service
              working-directory: ./user-service
              run: npm ci

            - name: Install dependencies - Product Service
              working-directory: ./product-service
              run: npm ci

            - name: Run npm audit - User Service
              working-directory: ./user-service
              run: npm audit --audit-level=moderate
              continue-on-error: true

            - name: Run npm audit - Product Service
              working-directory: ./product-service
              run: npm audit --audit-level=moderate
              continue-on-error: true

    # Code Security Scanning
    code-security-scan:
        name: Code Security Analysis
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Run Trivy vulnerability scanner in repo mode
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    # SAST - Static Application Security Testing
    sast-scan:
        name: SAST Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Run Semgrep
              uses: returntocorp/semgrep-action@v1
              with:
                  config: >-
                      p/security-audit
                      p/nodejs
                      p/docker

    # Secret Scanning
    secret-scan:
        name: Secret Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Gitleaks Scan
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Build and Test
    build-and-test:
        name: Build and Test Services
        runs-on: ubuntu-latest
        needs: [dependency-check, code-security-scan]
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install and build User Service
              working-directory: ./user-service
              run: |
                  npm ci
                  npm run start &
                  sleep 5
                  kill %1

            - name: Install and build Product Service
              working-directory: ./product-service
              run: |
                  npm ci
                  npm run start &
                  sleep 5
                  kill %1

    # Docker Image Security Scanning
    docker-security-scan:
        name: Docker Image Security Scan
        runs-on: ubuntu-latest
        needs: build-and-test
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build User Service Docker Image
              uses: docker/build-push-action@v4
              with:
                  context: ./user-service
                  file: ./user-service/Dockerfile
                  push: false
                  tags: user-service:${{ github.sha }}
                  load: true

            - name: Build Product Service Docker Image
              uses: docker/build-push-action@v4
              with:
                  context: ./product-service
                  file: ./product-service/Dockerfile
                  push: false
                  tags: product-service:${{ github.sha }}
                  load: true

            - name: Scan User Service Image with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: user-service:${{ github.sha }}
                  format: "table"
                  exit-code: "0"
                  severity: "CRITICAL,HIGH"

            - name: Scan Product Service Image with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: product-service:${{ github.sha }}
                  format: "table"
                  exit-code: "0"
                  severity: "CRITICAL,HIGH"

    # Security Report
    security-report:
        name: Generate Security Report
        runs-on: ubuntu-latest
        needs:
            [
                dependency-check,
                code-security-scan,
                sast-scan,
                secret-scan,
                docker-security-scan,
            ]
        if: always()
        steps:
            - name: Security Scan Summary
              run: |
                  echo "## ðŸ”’ DevSecOps Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Dependency Security Scan: Completed" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Code Security Analysis: Completed" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… SAST Scanning: Completed" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Secret Scanning: Completed" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Docker Image Security: Completed" >> $GITHUB_STEP_SUMMARY
